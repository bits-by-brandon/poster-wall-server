<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <style>
        * {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
        }
        body, html {
            padding: 0;
            margin: 0;
            background-color: black;
        }
        .alert-wrapper {
            background: white;
            padding: 20px;
            bottom: 20px;
            left: 20px;
            max-width: 40vw;
            width: auto;
            height: auto;
            opacity: 0;
            position: fixed;
            text-align: center;
        }
        .alert-text {
            color: black;
            font-family: sans-serif;
            font-size: 2vw;
        }
        .content-wrapper {
            height: 100vh;
            width: 100vw;
            overflow: visible;
            position: absolute;
            top: 0;
            left: 0;
            /*perspective: 500px;*/
            transform: rotate(90deg) translate(300px, -110px);
            cursor: none;
        }
        .card-column {
            width: 111px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 10px;
            position: relative;
        }
        .card-wrapper {
            display: flex;
            flex-wrap: wrap;
/*            transform-style: preserve-3d;*/
/*            transform: rotateX(2deg);*/
/*            transform-origin: center;*/
        }
        .card {
            margin-bottom: 14px;
            height: 220px;
            width: 100%;
            background-color: white;
            outline: 1px solid white;
            opacity: 0;
        }
        .card-column:first-of-type{
            margin-left: 0;
        }
        .card-column:last-of-type{
            margin-right: 0;
        }
        .card-column:nth-of-type(odd)
        {
            /*margin-top: 160px*/
        }

        .card-column:nth-of-type(even) {
            margin-top: 140px;
        }

        .active {
            opacity: 1;
        }

        /* ---card specifics--- */
        #c1{height: 223px;}
        #c2{height: 216px; width: calc(100% - 1px)}
        #c3{height: 240px; width: calc(100% + 6px)}
        #c4{height: 204px;}
        #c5{height: 217px; width: calc(100% + 4px);}
        #c6{height: 203px;}
        #c7{height: 208px;}
        #c8{height: 213px; width: calc(100% - 1px)}
        #c9{height: 227px;}
        #c10{height: 230px;}
        #c11{height: 222px;}
        #c12{height: 236px; width: calc(100% - 4px)}
        #c13{height: 206px;}
        #c14{height: 233px;}
        #c15{height: 230px; width: calc(100% - 5px)}
    </style>
</head>
<body>
   <div class="content-wrapper">
    <div class="card-wrapper">
        <div class="card-column">
            <div class="card" id="c1"></div>
            <div class="card" id="c6"></div>
            <div class="card" id="c11"></div>        
        </div>
        
        <div class="card-column">
            <div class="card" id="c2"></div>
            <div class="card" id="c7"></div>
            <div class="card" id="c12"></div>
        </div>
        
        <div class="card-column">
            <div class="card" id="c3"></div>
            <div class="card" id="c8"></div>
            <div class="card" id="c13"></div>
        </div>
        
        <div class="card-column">
            <div class="card" id="c4"></div>
            <div class="card" id="c9"></div>
            <div class="card" id="c14"></div>
        </div>
        
        <div class="card-column">
            <div class="card" id="c5"></div>
            <div class="card" id="c10"></div>
            <div class="card" id="c15"></div>
        </div>
        </div>
    </div>
   <div id="alert" class="alert-wrapper">
       <span id="alert-text" class="alert-text"></span>
   </div>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.0.2/TweenMax.min.js"></script>
   <script src="/socket.io/socket.io.js"></script>
   <script>
       let timeline = new TimelineMax({ repeat: -1, repeatDelay: 1 });

       const socket = io();
       const cardList = document.getElementsByClassName('card');
       const alertText = document.getElementById('alert-text');
       const alertWrapper = document.getElementById('alert');

       socket.on('MESSAGE', function(msg) {
         showAlert(msg);
       });

       socket.on('SET_PATTERN', function(pattern) {
         showAlert('switching pattern to: ' + pattern);

         //Turn all posters off
         TweenLite
             .to(".card", 0.3, {opacity: 0, ease: Power1.easeIn})
             .eventCallback('onComplete', function() {
               // Execute pattern
               switch (pattern){
                 case "spotlight":
                   spotlight(timeline, cardList, []);
                   break;
                 case "pulse":
                   pulse(timeline, cardList);
                   break;
               }
             })
       });

       socket.on('COMMAND', function(command) {
         showAlert('running command: ' + command);

         switch (command) {
           case "off":
             off();
         }
       });

       function showAlert(msg){
         alertText.innerHTML = msg;

         TweenLite.to(alertWrapper, 0.5, {opacity: 1, ease: Power1.easeIn})
         TweenLite.to(alertWrapper, 0.5, {opacity: 0, ease: Power1.easeIn, delay: 3})
       }

        function getRandomInt(min, max){
            return Math.floor(Math.random() * (max - min) + min);
        }

        function off() {
         timeline.clear();
         TweenLite.to(".card", 0.3, {opacity: 0, ease: Power1.easeIn})
        }

        function spotlight(timeline, cardList, spotlightedArray) {
            console.log('spotlight');
            timeline.clear();
            timeline.repeat(0);

            let random;
            if(spotlightedArray.length === cardList.length){
                spotlightedArray = [];
            }
            do{
                random = getRandomInt(0, cardList.length);
            } while(spotlightedArray.includes(random));
            spotlightedArray.push(random);
            console.log(spotlightedArray);
            timeline.add(TweenLite.to(cardList[random], 1, {opacity: 1}))
            timeline.add(TweenLite
                .to(cardList[random], 1, {opacity: 0, delay: 4})
                .eventCallback('onComplete', function(){
                  spotlight(timeline, cardList, spotlightedArray);
                })
            )
        }

        function pulse(timeline) {
         console.log('pulse');
          timeline.clear();
          timeline.repeat(-1);
          timeline.yoyo(true);
          timeline
            .to(".card", 5, {opacity: 1})
            .to(".card", 5, {opacity: 0});
        }

        function scan(timeline, cardList) {
          timeline.clear();

          const scanSpeed = 30;
          const glowSpeed = 1.3;
          const delaySpeed = 2;
          const preDelayFunc = function(i){
            return (cardList[i].getBoundingClientRect().left * 0.0001 * scanSpeed).toFixed(3);
          }
          let max = preDelayFunc(0);
          for(let i = 0; i < cardList.length; i++){
            max = Math.max(preDelayFunc(i), max);
          }
          const delayFunc = function(i){
            return (max - (cardList[i].getBoundingClientRect().left * 0.0001 * scanSpeed)).toFixed(3);
          }
          let delayMap = [];
          for(let i = 0; i < cardList.length; i++){
            delayMap.push(delayFunc(i));
          }

          for(let i = 0; i < cardList.length; i++){
              let loop = new TimelineMax();
              // let tl = new TimelineLite();
              loop
                .to(cardList[i], glowSpeed, {opacity: 1, ease: Power1.easeIn, delay: delaySpeed})
                .to(cardList[i], glowSpeed, {opacity: 0, ease: Power1.easeOut })
                .repeat(-1)

              // tl.from( cardList[i], glowSpeed, { opacity: 1, ease: Power0.easeOut, delay: delayMap[i] })
              //   .add( loop )

            timeline.add(new TimelineLite()
                .from( cardList[i], glowSpeed, { opacity: 1, ease: Power0.easeOut, delay: delayMap[i] })
                .add( loop ));
          }
        }

       // spotlight(cardList, []);
       //  chase(cardList, 0);
       //  scan(timeline, cardList);
       // pulse(timeline);
       //  gScan(cardList, false);
    </script>
    
</body>
</html>